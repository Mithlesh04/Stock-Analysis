
var tempData = [
    {    
        OPEN: '1689',    
        HIGH: '1689',    
        LOW: '1650',     
        CLOSE: '1672.45',
        LAST: '1665'     
      },
      {    
        OPEN: '1530',    
        HIGH: '1530',
        LOW: '1470',
        CLOSE: '1508.05',
        LAST: '1508.05'
      },
      {
        OPEN: '1880.2',
        HIGH: '1895',
        LOW: '1854',
        CLOSE: '1861.75',
        LAST: '1861.75'
      },
      {
        OPEN: '2000',
        HIGH: '2005',
        LOW: '1904',
        CLOSE: '1940.5',
        LAST: '1940.5'
      },
      {
        OPEN: '2530',
        HIGH: '2543.9',
        LOW: '2450',
        CLOSE: '2508.4',
        LAST: '2508.4'
      },
      {
        OPEN: '2790',
        HIGH: '2810',
        LOW: '2662',
        CLOSE: '2696.8',
        LAST: '2696.8'
      },
      {
        OPEN: '1615',
        HIGH: '1639.9',
        LOW: '1610.15',
        CLOSE: '1620',
        LAST: '1620'
      },
      {
        OPEN: '1663',
        HIGH: '1760',
        LOW: '1663',
        CLOSE: '1743.75',
        LAST: '1743.75'
      },
      {
        OPEN: '1514.9',
        HIGH: '1583.8',
        LOW: '1495.25',
        CLOSE: '1529.9',
        LAST: '1529.9'
      },
      {
        OPEN: '1480',
        HIGH: '1495',
        LOW: '1422',
        CLOSE: '1432.7',
        LAST: '1432.7'
      },
      {
        OPEN: '2035',
        HIGH: '2042.95',
        LOW: '2001.05',
        CLOSE: '2030.7',
        LAST: '2030.7'
      },
      {
        OPEN: '1942',
        HIGH: '1964.5',
        LOW: '1912',
        CLOSE: '1945.2',
        LAST: '1945.2'
      },
      {
        OPEN: '2601',
        HIGH: '2678',
        LOW: '2590.3',
        CLOSE: '2653',
        LAST: '2653'
      },
      {
        OPEN: '1620',
        HIGH: '1620',
        LOW: '1590.35',
        CLOSE: '1606.55',
        LAST: '1606.55'
      },
      {
        OPEN: '1432.7',
        HIGH: '1454',
        LOW: '1397.1',
        CLOSE: '1423.95',
        LAST: '1423.95'
      },
      {
        OPEN: '1690',
        HIGH: '1709.9',
        LOW: '1660',
        CLOSE: '1679.2',
        LAST: '1666.9'
      },
      {
        OPEN: '2035',
        HIGH: '2039.7',
        LOW: '1968',
        CLOSE: '1998.2',
        LAST: '1998.2'
      },
      {
        OPEN: '1971',
        HIGH: '1997',
        LOW: '1956.05',
        CLOSE: '1988.7',
        LAST: '1988.7'
      },
      {
        OPEN: '1990',
        HIGH: '2016',
        LOW: '1960',
        CLOSE: '2000.25',
        LAST: '2000.25'
      },
      {
        OPEN: '2512',
        HIGH: '2692',
        LOW: '2512',
        CLOSE: '2594.2',
        LAST: '2594.2'
      },
      {
        OPEN: '2825',
        HIGH: '2841',
        LOW: '2475',
        CLOSE: '2746.25',
        LAST: '2746.25'
      },
      {
        OPEN: '1606',
        HIGH: '1606',
        LOW: '1571.15',
        CLOSE: '1581.05',
        LAST: '1581.05'
      },
      {
        OPEN: '1436',
        HIGH: '1504',
        LOW: '1436',
        CLOSE: '1497.25',
        LAST: '1497.25'
      },
      {
        OPEN: '1687',
        HIGH: '1708',
        LOW: '1627.7',
        CLOSE: '1634.45',
        LAST: '1634.45'
      },
      {
        OPEN: '1841',
        HIGH: '1916',
        LOW: '1841',
        CLOSE: '1877',
        LAST: '1877'
      },
      {
        OPEN: '2010',
        HIGH: '2029.5',
        LOW: '1975',
        CLOSE: '1979.65',
        LAST: '1979.65'
      },
      {
        OPEN: '2005',
        HIGH: '2074.4',
        LOW: '1995.35',
        CLOSE: '2059.55',
        LAST: '2059.55'
      },
      {
        OPEN: '2571',
        HIGH: '2587',
        LOW: '2470',
        CLOSE: '2494.65',
        LAST: '2499.5'
      },
      {
        OPEN: '2750',
        HIGH: '2759.9',
        LOW: '2722.5',
        CLOSE: '2735.2',
        LAST: '2735.2'
      },
      {
        OPEN: '1575',
        HIGH: '1634',
        LOW: '1557',
        CLOSE: '1611.15',
        LAST: '1611.15'
      },
      {
        OPEN: '1745',
        HIGH: '1821.95',
        LOW: '1736',
        CLOSE: '1817.25',
        LAST: '1817.25'
      },
      {
        OPEN: '1501',
        HIGH: '1513.7',
        LOW: '1470',
        CLOSE: '1495.15',
        LAST: '1495.15'
      },
      {
        OPEN: '1504',
        HIGH: '1534.9',
        LOW: '1493.05',
        CLOSE: '1527.85',
        LAST: '1527.85'
      },
      {
        OPEN: '1885',
        HIGH: '1903',
        LOW: '1850',
        CLOSE: '1897.35',
        LAST: '1897.35'
      },
      {
        OPEN: '1997',
        HIGH: '1997',
        LOW: '1933',
        CLOSE: '1949.95',
        LAST: '1941.5'
      },
      {
        OPEN: '2060',
        HIGH: '2079',
        LOW: '2032',
        CLOSE: '2053.1',
        LAST: '2053.1'
      },
      {
        OPEN: '2549',
        HIGH: '2549',
        LOW: '2450',
        CLOSE: '2455.05',
        LAST: '2455.05'
      },
      {
        OPEN: '2675',
        HIGH: '2675',
        LOW: '2602',
        CLOSE: '2607.15',
        LAST: '2607.15'
      },
      {
        OPEN: '2749',
        HIGH: '2755',
        LOW: '2720',
        CLOSE: '2741.3',
        LAST: '2741.3'
      },
      {
        OPEN: '1815',
        HIGH: '1815',
        LOW: '1787',
        CLOSE: '1799.4',
        LAST: '1799.4'
      },
      {
        OPEN: '1501',
        HIGH: '1547',
        LOW: '1487',
        CLOSE: '1500.95',
        LAST: '1500.95'
      },
      {
        OPEN: '1869.9',
        HIGH: '1891',
        LOW: '1825.6',
        CLOSE: '1830.7',
        LAST: '1830.7'
      },
      {
        OPEN: '1958.85',
        HIGH: '1958.85',
        LOW: '1908',
        CLOSE: '1916.05',
        LAST: '1916.05'
      },
      {
        OPEN: '1950',
        HIGH: '1967',
        LOW: '1925',
        CLOSE: '1942.7',
        LAST: '1942.25'
      },
      {
        OPEN: '2040.55',
        HIGH: '2131',
        LOW: '2040',
        CLOSE: '2111.05',
        LAST: '2111.05'
      },
      {
        OPEN: '2607',
        HIGH: '2640',
        LOW: '2581.05',
        CLOSE: '2588.35',
        LAST: '2588.35'
      },
      {
        OPEN: '2769',
        HIGH: '2839.5',
        LOW: '2751',
        CLOSE: '2813.4',
        LAST: '2813.4'
      },
      {
        OPEN: '1820',
        HIGH: '1820',
        LOW: '1770.1',
        CLOSE: '1798.05',
        LAST: '1798.05'
      },
      {
        OPEN: '1539.95',
        HIGH: '1545',
        LOW: '1500',
        CLOSE: '1526.65',
        LAST: '1526.65'
      },
      {
        OPEN: '1657',
        HIGH: '1667.85',
        LOW: '1620',
        CLOSE: '1629.4',
        LAST: '1629.4'
      },
      {
        OPEN: '1815',
        HIGH: '1849.7',
        LOW: '1800',
        CLOSE: '1820.15',
        LAST: '1820.15'
      },
      {
        OPEN: '1975',
        HIGH: '1985',
        LOW: '1947.5',
        CLOSE: '1973.6',
        LAST: '1973.6'
      },
      {
        OPEN: '2101',
        HIGH: '2140',
        LOW: '2094',
        CLOSE: '2130.2',
        LAST: '2130.2'
      },
      {
        OPEN: '2609',
        HIGH: '2614.8',
        LOW: '2515',
        CLOSE: '2570.5',
        LAST: '2570.5'
      },
      {
        OPEN: '2848',
        HIGH: '2950',
        LOW: '2810',
        CLOSE: '2920.9',
        LAST: '2920.9'
      },
      {
        OPEN: '1630',
        HIGH: '1630',
        LOW: '1578.1',
        CLOSE: '1594.1',
        LAST: '1590'
      },
      {
        OPEN: '1808.85',
        HIGH: '1816',
        LOW: '1762.05',
        CLOSE: '1807.7',
        LAST: '1807.7'
      },
      {
        OPEN: '1530',
        HIGH: '1564',
        LOW: '1510',
        CLOSE: '1549.85',
        LAST: '1549.85'
      },
      {
        OPEN: '1629.4',
        HIGH: '1645.8',
        LOW: '1601.5',
        CLOSE: '1607.45',
        LAST: '1607.45'
      },
      {
        OPEN: '1800',
        HIGH: '1800',
        LOW: '1746',
        CLOSE: '1749.95',
        LAST: '1749.95'
      },
      {
        OPEN: '1980',
        HIGH: '2088',
        LOW: '1970',
        CLOSE: '2065.95',
        LAST: '2065.95'
      },
      {
        OPEN: '2495',
        HIGH: '2500',
        LOW: '2443',
        CLOSE: '2458.3',
        LAST: '2458.3'
      },
      {
        OPEN: '2512.5',
        HIGH: '2629.65',
        LOW: '2501',
        CLOSE: '2562.1',
        LAST: '2562.1'
      },
      {
        OPEN: '1599',
        HIGH: '1600',
        LOW: '1516',
        CLOSE: '1560.7',
        LAST: '1560.7'
      },
      {
        OPEN: '1819.95',
        HIGH: '1822',
        LOW: '1795',
        CLOSE: '1816.3',
        LAST: '1816.3'
      },
      {
        OPEN: '1570',
        HIGH: '1574',
        LOW: '1521',
        CLOSE: '1566.65',
        LAST: '1566.65'
      },
      {
        OPEN: '1525',
        HIGH: '1568',
        LOW: '1525',
        CLOSE: '1555.5',
        LAST: '1555.5'
      },
      {
        OPEN: '1610',
        HIGH: '1610',
        LOW: '1565.2',
        CLOSE: '1596.1',
        LAST: '1596.1'
      },
      {
        OPEN: '1937.1',
        HIGH: '1953.9',
        LOW: '1910',
        CLOSE: '1923.4',
        LAST: '1923.4'
      },
      {
        OPEN: '2065.95',
        HIGH: '2099',
        LOW: '2002',
        CLOSE: '2015.5',
        LAST: '2015.5'
      },
      {
        OPEN: '2465',
        HIGH: '2523',
        LOW: '2464',
        CLOSE: '2506',
        LAST: '2506'
      },
      {
        OPEN: '2562.1',
        HIGH: '2625',
        LOW: '2510',
        CLOSE: '2523.3',
        LAST: '2523.3'
      },
      {
        OPEN: '1569.85',
        HIGH: '1569.85',
        LOW: '1520',
        CLOSE: '1526.7',
        LAST: '1526.7'
      },
      {
        OPEN: '1541.25',
        HIGH: '1615',
        LOW: '1541.25',
        CLOSE: '1608',
        LAST: '1608'
      },
      {
        OPEN: '1620',
        HIGH: '1695',
        LOW: '1602',
        CLOSE: '1680',
        LAST: '1680'
      },
      {
        OPEN: '1953',
        HIGH: '1953',
        LOW: '1898.05',
        CLOSE: '1914.45',
        LAST: '1914.45'
      },
      {
        OPEN: '1925',
        HIGH: '1970',
        LOW: '1919',
        CLOSE: '1947.3',
        LAST: '1947.3'
      },
      {
        OPEN: '2038.85',
        HIGH: '2121.9',
        LOW: '2038.85',
        CLOSE: '2103.5',
        LAST: '2103.5'
      },
      {
        OPEN: '2550',
        HIGH: '2550',
        LOW: '2490',
        CLOSE: '2508.85',
        LAST: '2508.85'
      },
      {
        OPEN: '2944',
        HIGH: '2945',
        LOW: '2810.1',
        CLOSE: '2872.15',
        LAST: '2872.15'
      },
      {
        OPEN: '1531',
        HIGH: '1548.95',
        LOW: '1516',
        CLOSE: '1522.5',
        LAST: '1522.5'
      },
      {
        OPEN: '1615.55',
        HIGH: '1615.55',
        LOW: '1572',
        CLOSE: '1583.15',
        LAST: '1583.15'
      },
      {
        OPEN: '1655',
        HIGH: '1666',
        LOW: '1620',
        CLOSE: '1656.4',
        LAST: '1656.4'
      },
      {
        OPEN: '1780',
        HIGH: '1818',
        LOW: '1742',
        CLOSE: '1760.7',
        LAST: '1760.7'
      },
      {
        OPEN: '1915',
        HIGH: '1934',
        LOW: '1901.05',
        CLOSE: '1907.65',
        LAST: '1907.65'
      },
      {
        OPEN: '2104',
        HIGH: '2153',
        LOW: '2104',
        CLOSE: '2148.05',
        LAST: '2148.05'
      },
      {
        OPEN: '2512',
        HIGH: '2532.65',
        LOW: '2450',
        CLOSE: '2521.25',
        LAST: '2521.25'
      },
      {
        OPEN: '2935',
        HIGH: '2965',
        LOW: '2891',
        CLOSE: '2946.75',
        LAST: '2946.75'
      },
      {
        OPEN: '1565',
        HIGH: '1596',
        LOW: '1535',
        CLOSE: '1586.4',
        LAST: '1586.4'
      },
      {
        OPEN: '1825',
        HIGH: '1825',
        LOW: '1710',
        CLOSE: '1756.7',
        LAST: '1756.7'
      },
      {
        OPEN: '1568',
        HIGH: '1615',
        LOW: '1552',
        CLOSE: '1583.7',
        LAST: '1583.7'
      },
      {
        OPEN: '1569.8',
        HIGH: '1578',
        LOW: '1520',
        CLOSE: '1536.95',
        LAST: '1536.95'
      },
      {
        OPEN: '1766.9',
        HIGH: '1800',
        LOW: '1730',
        CLOSE: '1781.2',
        LAST: '1781.2'
      },
      {
        OPEN: '1939',
        HIGH: '1966',
        LOW: '1915',
        CLOSE: '1954.35',
        LAST: '1954.35'
      },
      {
        OPEN: '2159',
        HIGH: '2194.95',
        LOW: '2135.1',
        CLOSE: '2174.05',
        LAST: '2174.05'
      },
      {
        OPEN: '2450',
        HIGH: '2508',
        LOW: '2450',
        CLOSE: '2470.85',
        LAST: '2470.85'
      },
      {
        OPEN: '2495',
        HIGH: '2550',
        LOW: '2480',
        CLOSE: '2512.6',
        LAST: '2512.6'
      },
      {
        OPEN: '2884',
        HIGH: '3125',
        LOW: '2884',
        CLOSE: '3103.95',
        LAST: '3103.95'
      },
      {
        OPEN: '1771',
        HIGH: '1777',
        LOW: '1691',
        CLOSE: '1722.65',
        LAST: '1722.65'
      },
      {
        OPEN: '1585',
        HIGH: '1614',
        LOW: '1582',
        CLOSE: '1607.3',
        LAST: '1607.3'
      }
]

class TechnicalAnalysis{
    constructor(closeprice=[],key){
        if(typeof closeprice=='object'){
            let type = this.isAllElementsIsSameType(closeprice)
            if(type){  
                if(typeof closeprice[0]==='object'&&!Array.isArray(closeprice[0]) && key)this.closePrice=this.keyToArray(closeprice,key)
                else this.closePrice = closeprice
             }
         }
    }
   
/**
 * @keyToArray
 * @param {*} key 
 * @role : - from [{name:'ram'},{name:'punit'}] to = ['ram','punit']
 */
keyToArray(closePrice,key){
    var res = []
    if(typeof closePrice=='object' && key){ closePrice?.forEach((e)=>{let k = typeof e ==='object' && !Array.isArray(e) ? e[key] : null; res.push( typeof k==='string' ? Number(k.trim()) : Number(k)) }) }
   return res
  }
isAllElementsIsSameType(arr){
  var res = true
      if(typeof arr=='object' && Array.isArray(arr)){
          let t = '' , l = arr.length , i = 0
          for(;i<l;++i){
              let ty = typeof arr[i]
              if(ty){
                  if(!t)t=ty;
                  else{
                   if(t!==ty){
                       res=false
                       break;
                      }
                  }
               }
         } 
      }
  return res
  }
/**
   * @SMA Simple Moving Average
   * @param {*} day = 5 || 5day || 5days
   * @default 5days
   * @formula :- day1 + day2 + .... + nth day / No. of total days
   * @more info @https://youtu.be/cp6ASr9JrJQ
   * @returns array
   */
SMA(day=5) {
   day = typeof day=='number' ? day : Number(day?.match(/\d+/)[0])
   var SMA = [] , lnt = this.closePrice.length
   if(typeof this.closePrice=='object' && lnt >= day){  
    const push =  d =>{
        let n = 0
        d.forEach(e=>{
            let nU = Math.abs(Number(e))
            nU = nU ? nU : 0
            n = n+nU
        })
         return n / day
      }

    let l = this.closePrice.length
      for(let i=0;i<l;++i){
          let a= this.closePrice.slice(i,day+i)
            if(a.length>=day)SMA.push(push(a))
      }  
            
   }
  return SMA
 }
 /**
  * @EMA Expontional Moving Average
  * @param {*} day 
  * @param {*} prevEma - previous day EMA (:optional)
  * @default : - 10
  * @formula : - {close - EMA (previous day)} * multiplier + EMA (previous day)
  * Multiplier : - (2 / Time periods + 1)
  * @Note :- First observation we don't have a EMA the use "SMA" this is know as EMA for first time
  * @more info @https://youtu.be/ezcwBDsDviE
  * @returns array
  */
EMA(day=10,prevEma){
    var EMA = []
    day = typeof day=='number' ? day : Number(day?.match(/\d+/)[0])
    if(day){
        prevEma = prevEma ? prevEma : this.SMA(day)[0]
        let multiplier = 2 / ( day + 1 ), data = this.closePrice?.slice(day) ;
        if(prevEma){
           EMA.push(prevEma)
            data?.forEach(e=>{
            e = Number(e)
            if(e!=null && e!=''){
                let c = Number(((e - prevEma)*multiplier)+prevEma)
                EMA.push(c)
                prevEma = c
            }
              })
         }
    }
  return EMA
}
/**
 * @RSI Relative Strength Indicator
 * @param {*} day 
 * @default 14
 * @formula RSI = 100 - (100 / 1 + RS)
 *          RS - Relative Strength
 *          RS = Average Gain / Average Loss
 *          Average Gain  = row+1 - row
 *          Average Loss  = row+1 - row
 * @more info @https://youtu.be/HJCwLWTZGJo
 * @default : - 14
 * @return object 
 */
RSI(day=14){
  day = typeof day=='number' ? day : Number(day?.match(/\d+/)[0])
  var change = [] , gain = [] , loss = [] , AvGain = [] , AvLoss = [] , RS = [] , RSI = [] , lth = this.closePrice.length
  for(let i=1;i<lth;++i){
      let cal = Number(this.closePrice[i]) - Number(this.closePrice[i-1])
      if(cal>0){
        gain.push(cal)
        loss.push(0)
      }else{
        loss.push(Math.abs(cal))
        gain.push(0)
      }
     change.push(cal)
  }
  const calc =  d =>{let n = 0;d.forEach(e=>{let nU = Math.abs(Number(e));nU = nU ? nU : 0;n = n+nU});return n / (d.length)}
  let l = gain.length
    for(let i=0;i<l;++i){
       let a = gain.slice(i,day+i)
       let l = loss.slice(i,day+i)
       if(a.length>=day && l.length>=day){
           let ag = calc(a) , al = calc(l) , rs = ag/al
           AvGain.push(ag)
           AvLoss.push(al)
           RS.push(rs)
           if(al==0)RSI.push(100) ;else RSI.push( 100-( 100 / (1 + rs) ) )
        }
    }
 return{change:change,gain:gain,loss:loss,averageGain:AvGain,averageLoss:AvLoss,rs:RS,rsi:RSI}
}
/**
 * @MACD Moving Average Convergence Divergence 
 * @param {*} period1 = EMA period1  Default 12
 * @param {*} period2 = EMA period2  Default 26
 * @param {*} signal  = EMA signal   Default 9
 * @formula  MACD Line : (12-day EMA - 26-day EMA)
 *           Signal Line : 9-day EMA of MACD Line
 *           MACD Histogram : MACD Line - Signal Line
 * @more info @https://youtu.be/R8LcU_VS-1I
 * @returns object
 */
MACD(period1=12,period2=26,signal=9){
    period1 = typeof period1=='number' ? period1 : Number(period1?.match(/\d+/)[0])
    period2 = typeof period2=='number' ? period2 : Number(period2?.match(/\d+/)[0])
    signal = typeof signal=='number' ? signal : Number(signal?.match(/\d+/)[0])

    var fPeriod = this.EMA(period1) , sPeriod = this.EMA(period2) , MACD = [] , SIGNAL_LINE = [] , HISTOGRAM = []
    let l = Math.abs(fPeriod.length - sPeriod.length);
    sPeriod.forEach((e,i)=>{MACD.push(Number(fPeriod[l+i]) - Number(e))})
    const calc =  d =>{let n = 0;d.forEach(e=>{let nU = Math.abs(Number(e));nU = nU ? nU : 0;n = n+nU});return n / (d.length)}
    let ll = MACD.length , mls = Math.abs(signal-1)
    for(let i=0;i<ll;++i){
        let a = MACD.slice(i,signal+i)
          if(a.length>=signal){
              let s = calc(a)
              SIGNAL_LINE.push(s)
              HISTOGRAM.push( MACD[mls+i] - s )
            }
    }
return{period1:fPeriod,period2:sPeriod,macd:MACD,signal:SIGNAL_LINE,histogram:HISTOGRAM}
}

}

// let k = [1.45,1.45,14.6,14.25,14.4,11.7,7.8,7,9,9,10.15,8.3,9,11.4,12.7,12.55,11.5,15,16.2,16.4,18.75,18.35,14.65,13.8,12,14.75,18.8,20.25,21.25,19.95,20.05,21.5,21.3,23.15,24.45,26.55,27.25,28.85,31,33.5,31.9,34.65,32.9,32.15,29.75,32.2,30.4]//temp

let anlysis = new TechnicalAnalysis(tempData,'CLOSE')
let sma = anlysis.SMA()
let ema = anlysis.EMA()
let rsi = anlysis.RSI()
let macd = anlysis.MACD()
console.log("macd = ",macd)
console.log('sma = ',sma)
console.log("EMA = ",ema)
console.log("rsi = ",rsi)

